name: Deploy VPN Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Create deployment package
        run: |
          # Criar arquivo tar com todos os arquivos (exceto .git, venv, etc)
          # Criar em diret√≥rio tempor√°rio para evitar conflito "file changed as we read it"
          tar -czf /tmp/deploy.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            --exclude='*.tar.gz' \
            .
          # Mover para diret√≥rio atual
          mv /tmp/deploy.tar.gz ./deploy.tar.gz
      
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 300s
          command_timeout: 300s
          use_insecure_cipher: false
          debug: true
          source: "deploy.tar.gz"
          target: "/root/automais.io/vpnserver.io/"
      
      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 300s
          command_timeout: 300s
          use_insecure_cipher: false
          debug: true
          script: |
            echo "=== Iniciando deploy VPN Server ==="
            
            # Ir para diret√≥rio da aplica√ß√£o
            cd /root/automais.io/vpnserver.io
            
            echo "Extraindo arquivos..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            echo "üì¶ Instalando/atualizando depend√™ncias Python..."
            
            # Verificar se python3-venv est√° instalado
            if ! dpkg -l | grep -q python3-venv; then
              echo "Instalando python3-venv..."
              sudo apt-get update -qq
              sudo apt-get install -y python3-venv python3-pip
            fi
            
            # Remover venv antigo se existir mas estiver corrompido
            if [ -d "venv" ] && [ ! -f "venv/bin/activate" ]; then
              echo "Removendo venv corrompido..."
              rm -rf venv
            fi
            
            # Criar venv se n√£o existir
            if [ ! -d "venv" ]; then
              echo "Criando venv..."
              python3 -m venv venv
            fi
            
            # Verificar se venv foi criado corretamente
            if [ ! -f "venv/bin/activate" ]; then
              echo "‚ùå Erro: Falha ao criar venv. Verificando Python..."
              python3 --version
              which python3
              exit 1
            fi
            
            # Ativar venv e instalar depend√™ncias
            source venv/bin/activate
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet
            
            # Verificar se uvicorn foi instalado corretamente
            if [ ! -f "venv/bin/uvicorn" ]; then
              echo "‚ö†Ô∏è  uvicorn n√£o encontrado, instalando novamente..."
              pip install uvicorn[standard] --quiet
            fi
            
            # Verificar instala√ß√£o final
            if [ ! -f "venv/bin/uvicorn" ]; then
              echo "‚ùå Erro: uvicorn ainda n√£o est√° instalado"
              echo "Conte√∫do de venv/bin/:"
              ls -la venv/bin/ || true
              exit 1
            fi
            
            echo "‚úÖ Depend√™ncias instaladas"
            echo "Verificando instala√ß√£o:"
            ls -lh venv/bin/uvicorn || true
            
            # Verificar/criar arquivo de configura√ß√£o vpnserver.env
            if [ ! -f "/root/automais.io/vpnserver.env" ]; then
              echo "‚ö†Ô∏è  Arquivo vpnserver.env n√£o encontrado"
              if [ -f "vpnserver.env.example" ]; then
                echo "Criando vpnserver.env a partir do exemplo..."
                sudo cp vpnserver.env.example /root/automais.io/vpnserver.env
                sudo chmod 600 /root/automais.io/vpnserver.env
                echo "‚ö†Ô∏è  IMPORTANTE: Edite /root/automais.io/vpnserver.env com as configura√ß√µes corretas!"
              else
                echo "‚ùå Arquivo vpnserver.env.example n√£o encontrado no reposit√≥rio"
                echo "Crie manualmente o arquivo /root/automais.io/vpnserver.env"
              fi
            else
              echo "‚úì Arquivo vpnserver.env encontrado"
            fi
            
            # Copiar arquivo de servi√ßo systemd se existir
            if [ -f "deploy/vpnserverio.service" ]; then
              echo "Copiando arquivo de servi√ßo systemd..."
              sudo cp deploy/vpnserverio.service /etc/systemd/system/vpnserverio.service
              sudo chmod 644 /etc/systemd/system/vpnserverio.service
            fi
            
            echo "Verificando servi√ßo systemd..."
            if systemctl list-unit-files | grep -q vpnserverio.service; then
              echo "‚úì Servi√ßo encontrado"
              
              # Verificar se est√° habilitado
              if systemctl is-enabled vpnserverio.service >/dev/null 2>&1; then
                echo "‚úì Servi√ßo est√° habilitado"
              else
                echo "Habilitando servi√ßo..."
                sudo systemctl enable vpnserverio.service || echo "Aviso: Erro ao habilitar"
              fi
              
              # Recarregar systemd (caso o arquivo tenha sido atualizado)
              sudo systemctl daemon-reload
              
              echo "Reiniciando servi√ßo..."
              sudo systemctl restart vpnserverio.service
              
              # Aguardar um pouco e verificar status
              sleep 3
              echo "Status do servi√ßo:"
              sudo systemctl status vpnserverio.service --no-pager || true
            else
              echo "‚ö†Ô∏è  Servi√ßo vpnserverio.service n√£o encontrado"
              echo "Certifique-se de que o servi√ßo foi criado em /etc/systemd/system/vpnserverio.service"
              echo ""
              echo "Para criar o servi√ßo manualmente:"
              echo "  sudo cp deploy/vpnserverio.service /etc/systemd/system/"
              echo "  sudo systemctl daemon-reload"
              echo "  sudo systemctl enable vpnserverio.service"
              echo "  sudo systemctl start vpnserverio.service"
            fi
            
            echo "=== Deploy conclu√≠do ==="
