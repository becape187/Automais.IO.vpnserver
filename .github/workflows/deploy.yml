name: Deploy VPN Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Create deployment package
        run: |
          # Verificar arquivos de servi√ßo antes de criar o pacote
          echo "Verificando arquivos de servi√ßo antes de criar pacote:"
          ls -la deploy/*.service || echo "Aviso: Nenhum arquivo .service encontrado em deploy/"
          echo ""
          
          # Criar arquivo tar com todos os arquivos (exceto .git, venv, etc)
          # Criar em diret√≥rio tempor√°rio para evitar conflito "file changed as we read it"
          echo "Criando pacote de deploy..."
          tar -czf /tmp/deploy.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            --exclude='*.tar.gz' \
            .
          
          # Verificar se os arquivos de servi√ßo est√£o no tar
          echo "Verificando conte√∫do do pacote:"
          tar -tzf /tmp/deploy.tar.gz | grep -E "deploy/.*\.service" || echo "Aviso: Nenhum arquivo .service encontrado no pacote"
          
          # Mover para diret√≥rio atual
          mv /tmp/deploy.tar.gz ./deploy.tar.gz
          echo "‚úì Pacote criado: deploy.tar.gz"
      
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 300s
          command_timeout: 300s
          use_insecure_cipher: false
          debug: true
          source: "deploy.tar.gz"
          target: "/root/automais.io/vpnserver.io/"
      
      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          timeout: 300s
          command_timeout: 300s
          use_insecure_cipher: false
          debug: true
          script: |
            echo "=== Iniciando deploy VPN Server ==="
            
            # Ir para diret√≥rio da aplica√ß√£o
            cd /root/automais.io/vpnserver.io
            
            echo "Extraindo arquivos..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            echo "Verificando arquivos extra√≠dos..."
            echo "Conte√∫do do diret√≥rio deploy:"
            ls -la deploy/ || echo "Diret√≥rio deploy n√£o encontrado"
            echo ""
            echo "Verificando se arquivos de servi√ßo existem:"
            [ -f "deploy/vpnserverio.service" ] && echo "‚úì deploy/vpnserverio.service existe" || echo "‚úó deploy/vpnserverio.service N√ÉO existe"
            [ -f "deploy/routeros.service" ] && echo "‚úì deploy/routeros.service existe" || echo "‚úó deploy/routeros.service N√ÉO existe"
            
            echo "üì¶ Instalando/atualizando depend√™ncias Python..."
            
            # Verificar se python3-venv est√° instalado
            if ! dpkg -l | grep -q python3-venv; then
              echo "Instalando python3-venv..."
              sudo apt-get update -qq
              sudo apt-get install -y python3-venv python3-pip
            fi
            
            # Remover venv antigo se existir mas estiver corrompido
            if [ -d "venv" ] && [ ! -f "venv/bin/activate" ]; then
              echo "Removendo venv corrompido..."
              rm -rf venv
            fi
            
            # Criar venv se n√£o existir
            if [ ! -d "venv" ]; then
              echo "Criando venv..."
              python3 -m venv venv
            fi
            
            # Verificar se venv foi criado corretamente
            if [ ! -f "venv/bin/activate" ]; then
              echo "‚ùå Erro: Falha ao criar venv. Verificando Python..."
              python3 --version
              which python3
              exit 1
            fi
            
            # Ativar venv e instalar depend√™ncias
            source venv/bin/activate
            pip install --upgrade pip --quiet
            pip install -r requirements.txt --quiet
            
            # Verificar se uvicorn foi instalado corretamente
            if [ ! -f "venv/bin/uvicorn" ]; then
              echo "‚ö†Ô∏è  uvicorn n√£o encontrado, instalando novamente..."
              pip install uvicorn[standard] --quiet
            fi
            
            # Verificar instala√ß√£o final
            if [ ! -f "venv/bin/uvicorn" ]; then
              echo "‚ùå Erro: uvicorn ainda n√£o est√° instalado"
              echo "Conte√∫do de venv/bin/:"
              ls -la venv/bin/ || true
              exit 1
            fi
            
            echo "‚úÖ Depend√™ncias instaladas"
            echo "Verificando instala√ß√£o:"
            ls -lh venv/bin/uvicorn || true
            
            # Verificar/criar arquivo de configura√ß√£o vpnserver.env
            if [ ! -f "/root/automais.io/vpnserver.env" ]; then
              echo "‚ö†Ô∏è  Arquivo vpnserver.env n√£o encontrado"
              if [ -f "vpnserver.env.example" ]; then
                echo "Criando vpnserver.env a partir do exemplo..."
                sudo cp vpnserver.env.example /root/automais.io/vpnserver.env
                sudo chmod 600 /root/automais.io/vpnserver.env
                echo "‚ö†Ô∏è  IMPORTANTE: Edite /root/automais.io/vpnserver.env com as configura√ß√µes corretas!"
              else
                echo "‚ùå Arquivo vpnserver.env.example n√£o encontrado no reposit√≥rio"
                echo "Crie manualmente o arquivo /root/automais.io/vpnserver.env"
              fi
            else
              echo "‚úì Arquivo vpnserver.env encontrado"
            fi
            
            # Copiar arquivos de servi√ßo systemd se existirem
            echo "üì¶ Configurando servi√ßos systemd..."
            echo "Diret√≥rio atual: $(pwd)"
            echo "Verificando arquivos antes de copiar:"
            ls -la deploy/*.service 2>/dev/null || echo "Nenhum arquivo .service encontrado em deploy/"
            
            # Servi√ßo VPN Server (main)
            if [ -f "deploy/vpnserverio.service" ]; then
              echo "‚úì Copiando vpnserverio.service..."
              sudo cp -v deploy/vpnserverio.service /etc/systemd/system/vpnserverio.service
              sudo chmod 644 /etc/systemd/system/vpnserverio.service
              echo "‚úì vpnserverio.service copiado com sucesso"
            else
              echo "‚ö†Ô∏è  ERRO: Arquivo deploy/vpnserverio.service n√£o encontrado"
              echo "Conte√∫do do diret√≥rio deploy:"
              ls -la deploy/ || echo "Diret√≥rio deploy n√£o existe"
            fi
            
            # Servi√ßo RouterOS WebSocket
            if [ -f "deploy/routeros.service" ]; then
              echo "‚úì Copiando routeros.service..."
              sudo cp -v deploy/routeros.service /etc/systemd/system/routeros.service
              sudo chmod 644 /etc/systemd/system/routeros.service
              echo "‚úì routeros.service copiado com sucesso"
            else
              echo "‚ö†Ô∏è  ERRO: Arquivo deploy/routeros.service n√£o encontrado"
              echo "Conte√∫do do diret√≥rio deploy:"
              ls -la deploy/ || echo "Diret√≥rio deploy n√£o existe"
              echo "Procurando arquivo routeros.service em outros locais:"
              find . -name "routeros.service" -type f 2>/dev/null || echo "Arquivo n√£o encontrado em nenhum lugar"
              
              # Tentar criar o arquivo se n√£o existir (fallback)
              echo "‚ö†Ô∏è  Tentando criar routeros.service manualmente..."
              sudo tee /etc/systemd/system/routeros.service > /dev/null << 'EOF'
[Unit]
Description=RouterOS WebSocket Service - Gerenciamento RouterOS via WebSocket
After=network.target vpnserverio.service
Requires=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/automais.io/vpnserver.io
ExecStart=/root/automais.io/vpnserver.io/venv/bin/python3 /root/automais.io/vpnserver.io/routeros_websocket.py
Restart=always
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=routeros-websocket

# Timeouts
TimeoutStartSec=60
TimeoutStopSec=30
TimeoutAbortSec=10

# Vari√°veis de ambiente
Environment="PYTHONUNBUFFERED=1"
EnvironmentFile=/root/automais.io/vpnserver.env

[Install]
WantedBy=multi-user.target
EOF
              sudo chmod 644 /etc/systemd/system/routeros.service
              echo "‚úì routeros.service criado manualmente"
            fi
            
            # Recarregar systemd (caso os arquivos tenham sido atualizados)
            sudo systemctl daemon-reload
            
            # Configurar e iniciar vpnserverio.service
            echo ""
            echo "üîß Configurando vpnserverio.service..."
            if systemctl list-unit-files | grep -q vpnserverio.service; then
              echo "‚úì Servi√ßo vpnserverio encontrado"
              
              # Verificar se est√° habilitado
              if systemctl is-enabled vpnserverio.service >/dev/null 2>&1; then
                echo "‚úì Servi√ßo vpnserverio est√° habilitado"
              else
                echo "Habilitando vpnserverio.service..."
                sudo systemctl enable vpnserverio.service || echo "Aviso: Erro ao habilitar"
              fi
              
              echo "Reiniciando vpnserverio.service..."
              sudo systemctl restart vpnserverio.service
              
              # Aguardar um pouco e verificar status
              sleep 3
              echo "Status do vpnserverio.service:"
              sudo systemctl status vpnserverio.service --no-pager || true
            else
              echo "‚ö†Ô∏è  Servi√ßo vpnserverio.service n√£o encontrado"
              echo "Para criar o servi√ßo manualmente:"
              echo "  sudo cp deploy/vpnserverio.service /etc/systemd/system/"
              echo "  sudo systemctl daemon-reload"
              echo "  sudo systemctl enable vpnserverio.service"
              echo "  sudo systemctl start vpnserverio.service"
            fi
            
            # Configurar e iniciar routeros.service
            echo ""
            echo "üîß Configurando routeros.service..."
            if systemctl list-unit-files | grep -q routeros.service; then
              echo "‚úì Servi√ßo routeros encontrado"
              
              # Verificar se est√° habilitado
              if systemctl is-enabled routeros.service >/dev/null 2>&1; then
                echo "‚úì Servi√ßo routeros est√° habilitado"
              else
                echo "Habilitando routeros.service..."
                sudo systemctl enable routeros.service || echo "Aviso: Erro ao habilitar"
              fi
              
              echo "Reiniciando routeros.service..."
              sudo systemctl restart routeros.service
              
              # Aguardar um pouco e verificar status
              sleep 3
              echo "Status do routeros.service:"
              sudo systemctl status routeros.service --no-pager || true
            else
              echo "‚ö†Ô∏è  Servi√ßo routeros.service n√£o encontrado"
              echo "Para criar o servi√ßo manualmente:"
              echo "  sudo cp deploy/routeros.service /etc/systemd/system/"
              echo "  sudo systemctl daemon-reload"
              echo "  sudo systemctl enable routeros.service"
              echo "  sudo systemctl start routeros.service"
            fi
            
            echo "=== Deploy conclu√≠do ==="
